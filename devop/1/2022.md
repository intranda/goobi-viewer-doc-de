# 2022

## Allgemein

Zum Update des Goobi viewer Indexers auf die neuste Version immer die folgenden Kommandos benutzen:

```
mkdir -p /root/BACKUP/$(date -I)
systemctl stop solrindexer
mv /opt/digiverso/indexer/solrIndexer.jar /root/BACKUP/$(date -I)
wget -O /opt/digiverso/indexer/solrIndexer.jar https://github.com/intranda/goobi-viewer-indexer/releases/latest/download/solrIndexer.jar
systemctl start solrindexer
```

## 22.06

{% hint style="warning" %}
Mit dem Update ist **zwingend** eine **Neuindexierung** des Datenbestandes notwendig!
{% endhint %}

### Apache

In der Apache Konfigurationsdatei befinden sich gegebenenfalls. noch veraltete Optionen, die unter Umständen das Funktionieren von Websockets verhindern. Sofern vorhanden müssen diese beiden Zeilen gelöscht werden:

```
SetEnv force-proxy-request-1.0 1
SetEnv proxy-nokeepalive 1
```

### Jenkinsfile

Innerhalb der Jenkinsfile soll sichergestellt sein, dass während des build stages der folgende step aufgerufen wird:

```
sh 'mvn -f goobi-viewer-theme-*/pom.xml clean package -U'
```

### Goobi viewer Indexer

Der Indexer schreibt das neue Feld `MONTHDAY` und normalisiert die Werte in `DATE_PUBLICRELEASEDATE` wofür ein Update des Schemas erforderlich ist.

```bash
mkdir /root/BACKUP/$(date -I)
cp /opt/digiverso/solr/solr/server/solr/configsets/goobiviewer/conf/schema.xml /root/BACKUP/$(date -I)
wget -O /opt/digiverso/solr/solr/server/solr/configsets/goobiviewer/conf/schema.xml https://raw.githubusercontent.com/intranda/goobi-viewer-indexer/master/goobi-viewer-indexer/src/main/resources/other/schema.xml
chown solr. /opt/digiverso/solr/solr/server/solr/configsets/goobiviewer/conf/schema.xml
cd /opt/digiverso/solr/solr/
sudo -u solr bin/solr zk upconfig -n goobiviewer -d server/solr/configsets/goobiviewer/
curl "http://localhost:8983/solr/admin/collections?action=RELOAD&name=collection1&wt=xml"
```

Außerdem muss die Felddefinition für `MDNUM_PUBLICRELEASEDATE` durch die folgende für `DATE_PUBLICRELEASEDATE` ersetzt werden:

```xml
<DATE_PUBLICRELEASEDATE>
    <list>
        <item>
            <xpath>mets:xmlData/mods:mods/mods:accessCondition[@type='restriction on access'][translate(., translate(.,'0123456789',''), '')]</xpath>
            <addToDefault>false</addToDefault>
            <addUntokenizedVersion>false</addUntokenizedVersion>
            <addToChildren>true</addToChildren>
            <addToPages>true</addToPages>
        </item>
    </list>
</DATE_PUBLICRELEASEDATE>
```

Ob auf einem System eine Moving Wall für eine Zugriffsbeschränkung konfiguriert wurde kann mit dem folgenden SQL Snippet ermittelt werden:

```sql
SELECT * FROM license_types WHERE moving_wall=1;
```

Außerdem wurde die Indexierung des MIMETYPE geändert. Mit dem Update des Goobi viewers auf die Version 22.06 ist zwingend eine Neuindexierung des Datenbestandes notwendig!

## 22.05

### Apache

Die folgenden Einstellungen dienen dem allgemeinen Hardening vom Apache Webserver und dem Goobi viewers:

```diff
patch /etc/apache2/conf-available/security.conf << "EOF"
@@ -22,7 +22,7 @@
 # Set to one of:  Full | OS | Minimal | Minor | Major | Prod
 # where Full conveys the most information, and Prod the least.
 #ServerTokens Minimal
-ServerTokens OS
+ServerTokens Prod
 #ServerTokens Full
 
 #
@@ -33,7 +33,7 @@
 # Set to "EMail" to also include a mailto: link to the ServerAdmin.
 # Set to one of:  On | Off | EMail
 #ServerSignature Off
-ServerSignature On
+ServerSignature Off
 
 #
 # Allow TRACE method
EOF

a2enconf security
```

Danach die folgenden Zeilen in den Apache vHost mit einpflegen:

```
        ## Security
        # If set to 'none' the Matomo iFrame does not work anymore
        Header set Content-Security-Policy "frame-ancestors 'self';"
        Header always append X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set X-Content-Type-Options nosniff
```

Jetzt den Dienst neu starten:

```
systemctl restart apache2
```

### Tomcat

Die folgenden Einstellungen dienen dem allgemeinen Hardening vom Tomcat Application Server und dem Goobi viewers:

{% hint style="danger" %}
Wenn die Google OpenID Authentifizierung aktiv ist muss der Wert auf "lax" stehen, da diese ansonsten fehlschlägt.
{% endhint %}

```diff
patch /etc/tomcat9/context.xml << "EOF"
@@ -26,4 +26,7 @@
 
     <!-- Uncomment this to disable session persistence across Tomcat restarts -->
     <Manager pathname="" />
+
+    <!-- Set mode for the JSESSONID cookie. Google authentication needs "lax" -->
+    <CookieProcessor sameSiteCookies="strict" />
 </Context>
EOF
```

Weiter muss in der `/etc/tomcat9/server.xml` bei dem HTTP `<Connector />` Eintrag das Attribut `server=" "` hinzugefügt werden.

Nun noch den folgenden Eintrag in die `/etc/tomcat9/Catalina/localhost/viewer.xml` übernehmen:

```xml
    <Valve 
        className="org.apache.catalina.valves.ErrorReportValve" 
        showReport="false" 
        showServerInfo="false" />
```

Am Ende den Dienst neu starten:

```
systemctl restart tomcat9
```

### Cronjobs

Für die regelmäßige Abfrage des Status von neu beigetragenen Inhalten (sofern aktiv) muss die folgende Zeile in die `/etc/cron.d/intranda-goobiviewer` mit aufgenommen werden:

```
## This REST call checks the update status of contributed items
#42 *       * * *   root  curl -s -H "Content-Type: application/json" -H "token:GOOBIVIEWERAPITOKEN" -d '{"type":"UPDATE_UPLOAD_JOBS"}' -X POST http://localhost:8080/api/v1/tasks/ 1>/dev/null
```

### Goobi viewer Core

Der folgende Schalter kann aus der lokalen `config_viewer.xml` gelöscht werden. Die Werte werden nun programmatisch ermittelt:

```xml
<metadata>
    <metadataParamNumber>10</metadataParamNumber>
<metadata>
```

## 22.04

### Zitierlinks

Die Syntax für die Konfiguration der Zitierlinks hat sich verändert. Die Attribute `prefix`, `suffix` und `appendImageNumberToSuffix` sind entfallen. Anstelle dessen wurde das Attribut `pattern=""` eingeführt, das die beiden Platzhalter `{value}` (Wert des Feldes) und `{page}` (aktuelle Seitenzahl des geladenen Werkes) unterstützt.

Bei dem Update muss geprüft werden ob individuelle Einstellungen in der lokalen Konfigurationsdatei existieren. Diese sind dann bei Bedarf auf das neue Schema anzupassen.

```xml
<!-- OLD -->
<link type="URL" for="image" label="DOI" field="MD_PI_DOI" prefix="https://doi.org/" suffix="#?page=" topstructValueFallback="true" appendImageNumberToSuffix="true" />

<!-- NEW -->
<link type="URL" for="image" label="DOI" field="MD_PI_DOI" pattern="https://doi.org/{value}#?page={page}" topstructValueFallback="true" />
```

## 22.03

### Goobi viewer Core

#### Kommentare

Die Konfiguration der Kommentare wurde aus der Konfigurationsdatei in das Backend verschoben. Deswegen muss bei einem Update geprüft werden ob der Abschnitt `<comments />` in der lokalen `config_viewer.xml` existiert und wenn ja die Einstellungen gegebenenfalls migriert werden.

#### Suchtreffer

Die Konfiguration der Felder die bei der zusätzlichen Anzeige der Suchtreffer ignoriert oder übersetzt werden sollen hat sich geändert und muss angepasst werden.

```xml
<-- ALT -->
<displayAdditionalMetadata>
    <ignoreField>DC</ignoreField>
    <translateField>DOCSTRCT</translateField>
</displayAdditionalMetadata>

<-- NEU -->
<displayAdditionalMetadata>
    <field type="ignore">DC</field>
    <field type="translate">DOCSTRCT</field>
</displayAdditionalMetadata>
```

Bei der Migration können die folgenden Zeilen helfen:

```
mkdir -p /root/BACKUP/$(date -I)
cp /opt/digiverso/viewer/config/config_viewer.xml /root/BACKUP/$(date -I)
sed -e 's|<ignoreField>|<field type="ignore">|g' -e 's|</ignoreField>|</field>|g' -i /opt/digiverso/viewer/config/config_viewer.xml
sed -e 's|<translateField>|<field type="translate">|g' -e 's|</translateField>|</field>|g' -i /opt/digiverso/viewer/config/config_viewer.xml
```

#### Archive

Sofern die Funktionalität zur Anzeige von Archivbeständen verwendet wird muss die `findDB.xq` Datei aktualisiert werden.

```
wget -O /opt/digiverso/basex/webapp/findDB.xq https://raw.githubusercontent.com/intranda/goobi-plugin-administration-archive-management/master/plugin/src/main/resources/findDb.xq
```

### Goobi viewer Indexer

Damit zwischen einer Neuindexierung und einem aktualisierten Datensatz unterschieden werden kann schreibt der Goobi viewer Indexer ein neues Feld. Dafür muss das Solr-Schema aktualisiert werden.

```bash
mkdir /root/BACKUP/$(date -I)
cp /opt/digiverso/solr/solr/server/solr/configsets/goobiviewer/conf/schema.xml /root/BACKUP/$(date -I)
wget -O /opt/digiverso/solr/solr/server/solr/configsets/goobiviewer/conf/schema.xml https://raw.githubusercontent.com/intranda/goobi-viewer-indexer/master/goobi-viewer-indexer/src/main/resources/other/schema.xml
chown solr. /opt/digiverso/solr/solr/server/solr/configsets/goobiviewer/conf/schema.xml
cd /opt/digiverso/solr/solr/
sudo -u solr bin/solr zk upconfig -n goobiviewer -d server/solr/configsets/goobiviewer/
curl "http://localhost:8983/solr/admin/collections?action=RELOAD&name=collection1&wt=xml"
```

## 22.02

Bei einem Update auf diese Version sind keine Änderungen zu beachten.

## 22.01

### Goobi viewer Indexer

Die Feldnamen für die vom Goobi viewer Indexer indexierten Named Entity Tags werden ab sofort komplett in Großbuchstaben geschrieben. Damit in der Werksansicht das Widget in der Seitenleiste weiterhin angezeigt wird, müssen die betroffenen Werke neu indexiert werden. Ob Werke betroffen sind und wenn ja welche kann zum Beispiel mit dem folgenden Snippet auf der Kommandozeile ermittelt werden:

```bash
curl -s 'http://localhost:8983/solr/collection1/select?fl=PI&q=%7B!join%20from%3DPI_TOPSTRUCT%20to%3DPI%7D%2BPI_TOPSTRUCT%3A*%20%2B(NE_location_UNTOKENIZED%3A*%20NE_person_UNTOKENIZED%3A*)&rows=1000&wt=csv' | grep -v PI
```

### Goobi viewer Core

Bei dem Update auf 22.01 werden in der Datenbank die Widgets automatisch in die neue Struktur migriert. Deswegen sollte vorher auf jeden Fall ein Backup der Datenbank angelegt werden. Während der Migration wird darüber beim Start des Tomcats in der `catalina.out` in Form von `ERROR` Meldungen informiert. Dabei handelt es sich um keine Fehler sondern um Informationen die so besser sichtbar werden.

Wenn in der Installation individuelle Widgets in Verwendung sind, sollten diese nach dem Update im Backend geprüft werden.

```
mkdir -p /root/BACKUP/$(date -I)
mysqldump viewer | gzip > /root/BACKUP/$(date -I)/$(date -I).sql.gz
```
